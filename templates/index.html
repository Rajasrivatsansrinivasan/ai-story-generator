<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StoryWeaver X</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <style>
    body {
      background-color: #121212;
      color: #f2f2f2;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 900px;
      margin-top: 50px;
      background: #2c2c2c;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(255, 105, 180, 0.3);
    }
    .form-label {
      color: #ff79a8;
    }
    .form-control, .form-select {
      background-color: #1e1e1e;
      color: #f2f2f2;
      border: 1px solid #ff79a8;
    }
    .btn-primary {
      background-color: #ff4081;
      border-color: #ff4081;
    }
    .btn-primary:hover {
      background-color: #ff79a8;
      border-color: #ff79a8;
    }
    .story-box {
      white-space: pre-line;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      color: #eee;
    }
    .alert-danger {
      background-color: #ff4c6e;
      border: none;
    }
    #loading .spinner-border {
      width: 3rem;
      height: 3rem;
      color: #ff79a8;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="container">
  <div class="text-center mb-4">
    <img src="https://cdn-icons-png.flaticon.com/512/6394/6394861.png" alt="StoryWeaver X Logo" width="64" height="64" style="margin-bottom:10px;">
    <h2 style="color: #ff79a8;">✨ StoryWeaver X</h2>
    <p style="color: #ffffff;">Your AI-Powered Imagination Engine</p>
  </div>

  <div class="mb-4 text-center">
    <button class="btn btn-outline-light me-2" onclick="toggleMode('new')">🆕 New Story</button>
    <button class="btn btn-outline-light" onclick="toggleMode('continue')">🔁 Continue Story</button>
  </div>

  <form id="storyForm">
    <div id="newStoryFields">
      <div class="mb-3">
        <label class="form-label">Genre</label>
        <select class="form-select" id="genre" required>
          <option value="">Select a genre...</option>
          <option value="Fantasy">🧙 Fantasy</option>
          <option value="Science Fiction">🚀 Science Fiction</option>
          <option value="Horror">👻 Horror</option>
          <option value="Romance">💕 Romance</option>
          <option value="Mystery">🕵️ Mystery</option>
          <option value="Adventure">⚔️ Adventure</option>
          <option value="Comedy">😄 Comedy</option>
          <option value="Drama">🎭 Drama</option>
          <option value="Thriller">🔪 Thriller</option>
          <option value="Historical">🏛️ Historical</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Story Mood</label>
        <select class="form-select" id="mood">
          <option value="">No preference</option>
          <option value="Wholesome">🌞 Wholesome</option>
          <option value="Suspenseful">😱 Suspenseful</option>
          <option value="Uplifting">🌈 Uplifting</option>
          <option value="Dark">🌑 Dark</option>
          <option value="Emotional">💔 Emotional</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Story Description / Plot</label>
        <textarea class="form-control" id="plot" rows="3" placeholder="Enter the story idea or outline..." required></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Length</label>
        <select class="form-select" id="length" required>
          <option value="">Choose...</option>
          <option value="Short">Short (under 200 words)</option>
          <option value="Medium">Medium (300–500 words)</option>
          <option value="Long">Long (up to 800 words)</option>
        </select>
      </div>
    </div>

    <div id="continueStoryFields" class="hidden">
      <div class="mb-3">
        <label class="form-label">Upload Story (.txt)</label>
        <input type="file" id="storyFile" class="form-control" accept=".txt">
      </div>

      <div class="mb-3">
        <label class="form-label">Or Paste Your Story</label>
        <textarea class="form-control" id="storyPaste" rows="6" placeholder="Paste your existing story here..."></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Language</label>
        <select class="form-select" id="language"></select>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Prose Style</label>
        <select class="form-select" id="prose_style"></select>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">🚀 Generate Story</button>
  </form>

  <div id="loading" class="text-center my-4" style="display: none;">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p style="color: #aaa; margin-top: 10px;">Generating your story...</p>
  </div>

  <div id="result" class="mt-4" style="display: none;">
    <h4 style="color:#ff79a8;">📝 Generated Story</h4>
    <div class="story-box" id="storyText"></div>

    <div id="audioSection" class="mt-3" style="display: none;">
      <h5 style="color:#ff79a8;">🎧 Listen to your story:</h5>
      <audio id="audioPlayer" controls></audio>
    </div>

    <div class="mt-3">
      <a id="downloadText" class="btn btn-outline-success" download>📥 Download Text</a>
    </div>
  </div>

  <div id="error" class="alert alert-danger mt-3 d-none"></div>
</div>

<script>
  function toggleMode(mode) {
    const newFields = document.getElementById('newStoryFields');
    const contFields = document.getElementById('continueStoryFields');

    if (mode === 'new') {
      newFields.classList.remove('hidden');
      contFields.classList.add('hidden');
    } else {
      newFields.classList.add('hidden');
      contFields.classList.remove('hidden');
    }
  }

  async function populateOptions() {
    const proseRes = await fetch("/api/prose-styles");
    const proseStyles = await proseRes.json();
    const proseDropdown = document.getElementById("prose_style");
    for (const style in proseStyles) {
      const option = document.createElement("option");
      option.value = style;
      option.textContent = `${style} - ${proseStyles[style]}`;
      proseDropdown.appendChild(option);
    }

    const langRes = await fetch("/api/languages");
    const languages = await langRes.json();
    const langDropdown = document.getElementById("language");
    languages.forEach(lang => {
      const option = document.createElement("option");
      option.value = lang;
      option.textContent = lang;
      langDropdown.appendChild(option);
    });
  }

  function readFileAsText(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(reader.error);
      reader.readAsText(file);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    populateOptions();

    document.getElementById("storyForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const genre = document.getElementById("genre").value;
      const plot = document.getElementById("plot").value;
      const length = document.getElementById("length").value;
      const prose_style = document.getElementById("prose_style").value;
      const language = document.getElementById("language").value;
      const mood = document.getElementById("mood").value;
      const pasted = document.getElementById("storyPaste").value.trim();
      const file = document.getElementById("storyFile").files[0];

      const resultBox = document.getElementById("result");
      const storyText = document.getElementById("storyText");
      const audioSection = document.getElementById("audioSection");
      const audioPlayer = document.getElementById("audioPlayer");
      const downloadLink = document.getElementById("downloadText");
      const errorBox = document.getElementById("error");

      resultBox.style.display = "none";
      errorBox.classList.add("d-none");
      document.getElementById("loading").style.display = "block";
      audioSection.style.display = "none";

      let fullPrompt = "";
      if (!document.getElementById("newStoryFields").classList.contains("hidden")) {
        fullPrompt = `${plot}\n(Mood: ${mood})`;
      } else {
        if (file) {
          fullPrompt = await readFileAsText(file);
        } else {
          fullPrompt = pasted;
        }
      }

      try {
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ genre, plot: fullPrompt, length, prose_style, language, mood }),
        });

        const data = await res.json();
        document.getElementById("loading").style.display = "none";

        if (!res.ok) throw new Error(data.error || "Something went wrong!");

        storyText.textContent = data.story;
        resultBox.style.display = "block";
        downloadLink.href = data.text_file;

        if (data.audio_file) {
          audioPlayer.src = data.audio_file;
          audioSection.style.display = "block";
        }

      } catch (err) {
        document.getElementById("loading").style.display = "none";
        resultBox.style.display = "none";
        errorBox.textContent = err.message;
        errorBox.classList.remove("d-none");
      }
    });
  });
</script>

</body>
</html>